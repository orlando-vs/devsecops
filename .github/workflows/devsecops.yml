name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    # =========================
    # 1. Checkout
    # =========================
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================
    # 2. Setup Node
    # =========================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # =========================
    # 3. Create .env files (CI)
    # =========================
    - name: Create env files
      run: |
        cp backend/users-service/.env.example backend/users-service/.env
        cp backend/academic-service/.env.example backend/academic-service/.env
        cp backend/api-gateway/.env.example backend/api-gateway/.env
        cp frontend/.env.example frontend/.env

    # ====================================================
    # 4. INSTALLATION (Reproducible)
    # ====================================================
    - name: Install users-service
      run: |
        cd backend/users-service
        npm ci

    - name: Install academic-service
      run: |
        cd backend/academic-service
        npm ci

    - name: Install api-gateway
      run: |
        cd backend/api-gateway
        npm ci

    - name: Install frontend
      run: |
        cd frontend
        npm ci

    # ====================================================
    # 5. CODE QUALITY (ESLint)
    # ====================================================
    - name: Lint users-service
      run: |
        cd backend/users-service
        npm run lint

    - name: Lint academic-service
      run: |
        cd backend/academic-service
        npm run lint

    - name: Lint api-gateway
      run: |
        cd backend/api-gateway
        npm run lint

    - name: Lint frontend
      run: |
        cd frontend
        npm run lint

    # ====================================================
    # 6. TESTING
    # ====================================================
    - name: Test users-service
      run: |
        cd backend/users-service
        npm test

    - name: Test academic-service
      run: |
        cd backend/academic-service
        npm test

    - name: Test api-gateway
      run: |
        cd backend/api-gateway
        npm test

    - name: Test frontend
      run: |
        cd frontend
        npm test

    # ====================================================
    # 7. SAST – Semgrep
    # ====================================================
    - name: Install Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: Run SAST
      run: |
        semgrep --config=auto --severity ERROR

    # ====================================================
    # 8. SCA – npm audit (Dependency Security)
    # ====================================================
    - name: SCA users-service
      run: |
        cd backend/users-service
        npm audit --audit-level=high

    - name: SCA academic-service
      run: |
        cd backend/academic-service
        npm audit --audit-level=high

    - name: SCA api-gateway
      run: |
        cd backend/api-gateway
        npm audit --audit-level=high

    - name: SCA frontend
      run: |
        cd frontend
        npm audit --audit-level=high

    # ====================================================
    # 9. BUILD DOCKER IMAGES
    # ====================================================
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: docker compose -f backend/docker-compose.yml build

    # ====================================================
    # 10. CONTAINER SECURITY – Trivy
    # ====================================================
    - name: Scan images with Trivy
      uses: aquasecurity/trivy-action@0.20.0
      with:
        scan-type: image
        image-ref: users-service
        severity: HIGH,CRITICAL
        exit-code: 1
